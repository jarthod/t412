<html>
  <head>
    <title>T412</title>
    <meta charset="UTF-8">
    <style type="text/css">
      body { font-family: sans-serif; margin: 0 auto; padding: 0 2vw; color: #333; }
      a { color: #27b; text-decoration: none; }
      a:hover { text-decoration: underline; }
      header { display: flex; align-items: center; justify-content: space-between; margin: 2vh 0; }
      h1 { margin: 0; }
      #indicator { background-color: #27b; height: 3px; width: 0; }
      #indicator.loading { width: 100%; transition: width 2s ease-out; }
      #error { color: #e43; margin: 2vh 0; }
      form { margin: 0; }
      #search-form { display: flex; align-items: center; font-size: 1.5em; margin-bottom: 1.5vh; }
      #q { flex: 1; border: none; outline: none; font-size: 1em; margin-left: 0.5em; }
      table { width: 100%; }
      th { font-size: 0.8em; color: #888; text-transform: uppercase; padding: 1vh 0.5em; }
      td { padding: 0.5vh 0.5em; }
      .age, .size, .down, .seed { text-align: right; }
      .name { text-align: left; }
      .name i { font-style: normal; color: #e43; }
    </style>
  </head>
  <body>
    <div id="indicator"></div>
    <header>
      <h1><a href="https://github.com/jarthod/t412" target="blank">t412.rootbox.fr</a></h1>
      <form id="passkey-form" onchange="save(); return false;">
        YGG Passkey:
        <input type="text" id="passkey" name="passkey" size="40" pattern="\w{32}"/>
      </form>
    </header>
    <div id="error"></div>
    <div id="search">
      <form id="search-form" onsubmit="search(); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="q" name="q" placeholder="Query" autofocus="true"/>
      </form>
      <table id="torrents" cellpadding="0" cellspacing="0" border="0">
        <thead>
          <tr>
            <th class="name">Name</th>
            <th class="age">Age</th>
            <th class="size">Size</th>
            <th class="down">▼ Downs</th>
            <th class="seed">Seed</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script type="text/javascript">
      try {
        if (!'fetch' in window) {
          throw new Error("your browser doesn't support fetch, check out http://caniuse.com/#search=fetch");
        }

        var state = {};
        var debug = true;
        const categories = {
          2145: "🎞️ Film/Vidéo",
          2178: "🎞️ Films d’animation",
          2179: "🎞️ Séries d’animation / Mangas",
          2180: "🎞️ Concert",
          2181: "🎞️ Documentaires",
          2182: "🎞️ Émissions TV",
          2183: "🎞️ Film",
          2184: "🎞️ Série TV",
          2185: "🎞️ Spectacle",
          2186: "🎞️ Sport",
          2187: "🎞️ Vidéo-clips",
          2139: "🎵 Audio",
          2147: "🎵 Karaoké",
          2148: "🎵 Musique",
          2150: "🎵 Podcast Radio",
          2149: "🎵 Samples",
          2144: "💿 Application",
          2177: "💿 Autre",
          2176: "💿 Formation",
          2171: "💿 Linux",
          2172: "💿 MacOS",
          2174: "💿 Smartphone",
          2175: "💿 Tablette",
          2173: "💿 Windows",
          2142: "🎮 Jeu vidéo",
          2167: "🎮 Autre",
          2159: "🎮 Linux",
          2160: "🎮 MacOS",
          2162: "🎮 Microsoft",
          2163: "🎮 Nintendo",
          2165: "🎮 Smartphone",
          2164: "🎮 Sony",
          2166: "🎮 Tablette",
          2161: "🎮 Windows",
          2140: "📕 eBook",
          2151: "📕 Audio",
          2152: "📕 Bds",
          2153: "📕 Comics",
          2154: "📕 Livres",
          2155: "📕 Mangas",
          2156: "📕 Presse",
        }

        function formatBytes(bytes, decimals) {
           if (bytes === 0) return '0 Byte';
           var k = 1024; // or 1024 for binary
           var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
           var i = Math.floor(Math.log(bytes) / Math.log(k));
           return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} <small>${sizes[i]}</small>`;
        }

        function formatAge(time) {
          var delta = Math.round((+new Date - new Date(time)) / 1000);
          if (delta < 3600) {
            return `${Math.floor(delta / 60)} minutes`;
          } else if (delta < 3600 * 24) {
            return `${Math.floor(delta / 3600)} hours`;
          } else if (delta < 3600 * 24 * 30.5) {
            return `${Math.floor(delta / 3600 / 24)} days`;
          } else if (delta < 3600 * 24 * 30.5 * 12) {
            return `${Math.floor(delta / 3600 / 24 / 30.5)} months`;
          } else {
            return `${Math.floor(delta / 3600 / 24 / 365)} years`;
          }
        }

        function requestIndicatorStart() {
          var indicator = document.querySelector('#indicator');
          indicator.className = 'loading';
        }

        function handleErrors(param) {
          var indicator = document.querySelector('#indicator');
          indicator.className = '';
          if (param instanceof Response) {
            if (!param.ok)
              state.error = "Server error: " + param.statusText;
            else
              return param;
          } else
            state.error = "Error: " + param.message;
          render();
        }

        function save() {
          state.passkey = document.querySelector('#passkey').value;
          localStorage.setItem('ygg-passkey', state.passkey);
        }

        function search() {
          var query = document.querySelector('#q').value;
          const [, season, episode] = query.match(/S(\d+)(?:E(\d+))?/i) || [];
          const cleanedQuery = query.replace(/S\d+(?:E\d+)?/i, '').trim();
          var params = { q: cleanedQuery, order_by: "downloads", per_page: 25 }
          if (season) params.season = Number(season);
          if (episode) params.episode = Number(episode);
          if (debug) console.log(params);
          requestIndicatorStart();
          fetch(`https://yggapi.eu/torrents?${new URLSearchParams(params)}`)
          .then(handleErrors).then(response => response.json())
          .then(result => {
            delete state.error;
            if (result.error) {
              state.error = result.error;
            } else {
              state.torrents = result;
              localStorage.setItem('t412-torrents', JSON.stringify(state.torrents));
              localStorage.setItem('t412-query', query);
            }
            render();
          }).catch(handleErrors);
        }

        function renderTorrent(torrent) {
          return `<tr>
            <td class="name">
              ${categories[torrent.category_id]} /
              <a href="https://yggapi.eu/torrent/${torrent.id}/download?passkey=${state.passkey}">${torrent.title}</a>
              <a href="${torrent.link}" target="_blank">↗</a>
            </td>
            <td class="age">${formatAge(torrent.uploaded_at)}</td>
            <td class="size">${formatBytes(torrent.size)}</td>
            <td class="down">${torrent.downloads}</td>
            <td class="seed">${torrent.seeders}</td>
          </tr>`;
        }

        function render() {
          var torrentsTable = document.querySelector('#torrents');
          if (state.torrents) {
            torrentsTable.style.display = 'table';
            torrentsTable.querySelector('tbody').innerHTML = state.torrents.map(renderTorrent).join('');
          } else {
            torrentsTable.style.display = 'none';
          }
          document.querySelector('#error').innerText = (state.error ? '⚠ ' + state.error : '');
        }

        // Load saved infos
        state.passkey = localStorage.getItem('ygg-passkey');
        state.torrents = JSON.parse(localStorage.getItem('t412-torrents'));
        document.querySelector('#passkey').value = state.passkey

        //setup typing timer
        var typingTimer;
        var searchField = document.querySelector('#q');
        searchField.value = localStorage.getItem('t412-query');
        searchField.addEventListener('keyup', function(){
          clearTimeout(typingTimer);
          if (searchField.value) {
            typingTimer = setTimeout(search, 500);
          }
        });

        render();
      }
      catch (exc) {
        state.error = exc
        document.querySelector('#error').innerText = '⚠ ' + exc;
        throw exc
      }
    </script>
  </body>
</html>